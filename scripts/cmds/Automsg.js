const moment = require("moment-timezone");
const axios = require("axios");
const fs = require("fs");
const path = require("path");

module.exports.config = {
  name: 'automsg',
  version: "2.0.0",
  role: 0,
  author: "я╝оя╝йя╝▓ O я╝в",
  description: "Auto time message with random videos and painful notes",
  category: "AutoTime",
  countDown: 3
};

// ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛рж░ ржлрж╛ржВрж╢ржи
async function downloadVideo(url, filename) {
  const response = await axios.get(url, { responseType: "stream" });
  const filePath = path.join(__dirname, filename);
  const writer = fs.createWriteStream(filePath);
  response.data.pipe(writer);
  return new Promise((resolve, reject) => {
    writer.on("finish", () => resolve(filePath));
    writer.on("error", reject);
  });
}

module.exports.onLoad = async ({ api }) => {
  console.log("Automsg command loaded successfully! тЬЕ");
};

module.exports.onStart = async function({ api, event }) {
  // ржнрж┐ржбрж┐ржУ рж▓рж┐ржЩрзНржХ рж▓рзЛржб
  let videos = [];
  try {
    const response = await axios.get("https://raw.githubusercontent.com/nirob-kakashi66/60-/main/AutomsgVideo.json");
    videos = response.data;
  } catch (e) {
    console.error("тЭМ ржнрж┐ржбрж┐ржУ рж▓рж┐ржЩрзНржХ рж▓рзЛржб ржХрж░рж╛ ржпрж╛ржпрж╝ржирж┐:", e);
  }

  // painful ржХрж┐ржирзНрждрзБ рж╕рзБржирзНржжрж░ ржирзЛржЯ
  const notes = [
    "ЁЯТФ ржХржЦржирзЛ ржХржЦржирзЛ ржмрж┐ржжрж╛ржпрж╝ржЗ рж╣ржпрж╝ ржнрж╛рж▓рзЛржмрж╛рж╕рж╛рж░ ржЪрзВржбрж╝рж╛ржирзНржд рж╢рж┐ржХрзНрж╖рж╛ред ЁЯдН",
    "ЁЯМЩ рж░рж╛ржд ржпржд ржЧржнрзАрж░, рж╕рзНржорзГрждрж┐ржЧрзБрж▓рзЛ рждржд ржмрзЗрж╢рж┐ ржЪрж╛ржкрзЗ рж░рж╛ржЦрзЗред ЁЯзб",
    "ЁЯШФ рждрзЛржорж╛ржХрзЗ рж╣рж╛рж░рж┐ржпрж╝рзЗ ржЖржорж┐ рж╢рзБржзрзБ ржЦрж╛рж▓рж┐ ржмрзБржХрзЗ рж╢рзВржирзНржпрждрж╛ ржкрж╛ржЗред ЁЯЦд",
    "ЁЯМ╕ ржнрж╛рж▓рзЛржмрж╛рж╕рж╛рж░ ржЫрж╛ржпрж╝рж╛ ржорж╛ржЭрзЗ ржорж╛ржЭрзЗ рж╕ржмржЪрзЗржпрж╝рзЗ ржмрзНржпржерж╛рж░ ржорждрзЛ рж▓рж╛ржЧрзЗред ЁЯТЮ",
    "ЁЯТн ржХрж┐ржЫрзБ ржорж╛ржирзБрж╖ рж╢рзБржзрзБ рж╕рзНржорзГрждрж┐ рж╣ржпрж╝рзЗ ржпрж╛ржпрж╝, ржЫрзБржБрждрзЗ ржкрж╛рж░рж┐ ржирж╛ред ЁЯТЮ",
    "ЁЯХКя╕П ржоржирзЗ рж╣ржпрж╝ рждрзБржорж┐ рж╢рзБржзрзБ рж╕рзНржмржкрзНржирзЗ ржмрж╛ржБржЪржЫред ЁЯТЫ",
    "ЁЯМзя╕П ржЕрж╢рзНрж░рзБрж░ ржкрзНрж░рждрж┐ржЯрж╛ ржлрзЛржБржЯрж╛ рждрзЛржорж╛рж░ ржХржерж╛ ржоржирзЗ ржХрж░рж╛ржпрж╝ред ЁЯдН",
    "ЁЯФе ржпржирзНрждрзНрж░ржгрж╛рж░ ржорж╛ржЭрзЗ ржХржЦржирзЛ ржХржЦржирзЛ ржЖржорж░рж╛ рж╕ржмржЪрзЗржпрж╝рзЗ ржЬрзАржмрж┐ржд ржмрзЛржз ржХрж░рж┐ред тЩея╕П",
    "ЁЯМ╣ рж╣рж╛рж░рж╛ржирзЛ ржнрж╛рж▓рзЛржмрж╛рж╕рж╛ ржЕржирзЗржХ рж╕ржоржпрж╝ ржлрзБрж▓рзЗрж░ ржорждрзЛ ржоржзрзБрж░ рж▓рж╛ржЧрзЗред ЁЯШН",
    "ЁЯТл ржХрж┐ржЫрзБ рж╕ржорзНржкрж░рзНржХ рж╢рзБржзрзБ рж╣рзГржжржпрж╝рзЗрж░ ржХрзЛржгрзЗ ржерж╛ржХрзЗред ЁЯМ╗",
    "тЪб ржмрзНржпржерж╛ ржЫрж╛ржбрж╝рж╛ ржЖржорж┐ ржмрзБржЭрж┐ ржирж╛ рж╕рзБржЦрзЗрж░ ржжрж╛ржоред ЁЯТо",
    "ЁЯНВ рж╕ржмржХрж┐ржЫрзБ рж╢рзЗрж╖ рж╣рж▓рзЗржУ ржоржи ржПржЦржиржУ рждрзЛржорж╛ржпрж╝ ржЦрзБржБржЬрзЗ ржерж╛ржХрзЗред ЁЯМ╝",
    "ЁЯМИ ржпржирзНрждрзНрж░ржгрж╛рж░ ржорж╛ржЭрзЗржУ ржЖрж╢рж╛ ржорж┐рж╢рзЗ ржерж╛ржХрзЗред ЁЯМ╣",
    "ЁЯТФ рждрзБржорж┐ ржирзЗржЗ, ржЕржержЪ ржоржирзЗ рж╣ржпрж╝ рждрзБржорж┐ ржкрж╛рж╢рзЗ ржЖржЫред ЁЯМ║",
    "ЁЯМК ржиржжрзАрж░ ржорждрзЛ ржЖржорж╛рж░ ржЕржирзБржнрзВрждрж┐ ржХржЦржирзЛ ржерж╛ржорзЗ ржирж╛ред ЁЯТШ",
    "ЁЯМЯ рждрзЛржорж╛рж░ ржХржерж╛ ржнрж╛ржмрж▓рзЗ рж░рж╛рждржУ ржЬрзЗржЧрзЗ ржерж╛ржХрзЗред ЁЯШН",
    "ЁЯЦд ржХрж┐ржЫрзБ ржорж╛ржирзБрж╖ рж╢рзБржзрзБ рж╢рзВржирзНржпрждрж╛ рж░рзЗржЦрзЗ ржпрж╛ржпрж╝ред ЁЯЦд",
    "ЁЯО╡ ржмрзНржпржерж╛ ржХржЦржирзЛ ржХржЦржирзЛ рж╕ржмржЪрзЗржпрж╝рзЗ рж╕рзБржирзНржжрж░ ржЧрж╛ржи ржмрж╛ржирж╛ржпрж╝ред ЁЯШБ",
    "ЁЯМ╣ рждрзЛржорж╛рж░ ржЕржнрж╛ржм рж╣рзГржжржпрж╝ржХрзЗ ржЖрж░ржУ ржирж░ржо ржХрж░рзЗред тШ║я╕П",
    "ЁЯТн рж╕рзНржорзГрждрж┐ржЧрзБрж▓рзЛ ржХржЦржирзЛ ржнрзБрж▓рзЗ ржпрж╛ржпрж╝ ржирж╛, рж╢рзБржзрзБ ржЪрзБржкржЪрж╛ржк ржерж╛ржХрзЗред ЁЯе░",
    "ЁЯМ║ рж╣рж╛рж░рж╛ржирзЛ рж╣рж╛рж╕рж┐ ржорж╛ржЭрзЗ ржорж╛ржЭрзЗ рж╣рзГржжржпрж╝ ржЫрж┐ржБржбрж╝рзЗ ржжрзЗржпрж╝ред ЁЯШЕ",
    "ЁЯММ рж░рж╛рждрзЗрж░ ржирзАрж░ржмрждрж╛ ржпрзЗржи рждрзЛржорж╛рж░ ржХржгрзНржарж╕рзНржмрж░ ржмрж╛ржЬрж╛ржпрж╝ред ЁЯШК",
    "ЁЯТЦ ржмрзНржпржерж╛рж░ ржорж╛ржЭрзЗ рж╢рж┐ржЦрж┐ рж╕рждрзНржпрж┐ржХрж╛рж░ ржнрж╛рж▓ржмрж╛рж╕рж╛ ржХржд рж╕рзБржирзНржжрж░ред ЁЯЩВ"
  ];

  // ржкрзНрж░рждрж┐ ржШржирзНржЯрж╛ржпрж╝ ржкрж╛ржарж╛ржирзЛрж░ ржорзЗрж╕рзЗржЬ
  const messagesByTime = {};
  for (let i = 0; i < 24; i++) {
    const hour = i.toString().padStart(2, '2');
    const suffix = i < 12 ? "AM" : "PM";
    messagesByTime[`${hour}:00:00 ${suffix}`] = {
      message: "====== ЁЯР╛ ЁЭЧФЁЭЧиЁЭЧзЁЭЧв ЁЭЧжЁЭЧШЁЭЧбЁЭЧЧ ЁЯР╛ ======\nтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ\nтЮЭ ЁЭЧбЁЭЧ╝ЁЭШД ЁЭЧЬЁЭША: " + hour + ":00 " + suffix
    };
  }

  // ржкрзНрж░рждрж┐ рж╕рзЗржХрзЗржирзНржбрзЗ ржкрж░рзАржХрзНрж╖рж╛ ржХрж░рж╛
  setInterval(async () => {
    const currentTime = moment().tz("Asia/Dhaka").format("hh:mm:ss A");
    if (messagesByTime[currentTime]) {
      const baseMsg = messagesByTime[currentTime].message;
      const randomNote = notes[Math.floor(Math.random() * notes.length)];
      let finalMsg = `${baseMsg}\n\nЁЯТм: ${randomNote}\nтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ\nтЮЭ ЁЭЧзЁЭЧ╡ЁЭЧ╢ЁЭША ЁЭЧЬЁЭША ЁЭЧФЁЭЧ╗ ЁЭЧФЁЭШВЁЭШБЁЭЧ╝ЁЭЧ║ЁЭЧоЁЭШБЁЭЧ╢ЁЭЧ░ ЁЭЧаЁЭЧ▓ЁЭШАЁЭШАЁЭЧоЁЭЧ┤ЁЭЧ▓`;

      if (videos.length > 0) {
        const randomVideoUrl = videos[Math.floor(Math.random() * videos.length)];
        try {
          const videoPath = await downloadVideo(randomVideoUrl, "tempvideo.mp4");
          api.sendMessage({ body: finalMsg, attachment: fs.createReadStream(videoPath) }, event.threadID);
          fs.unlinkSync(videoPath); // ржкрж╛ржарж╛ржирзЛрж░ ржкрж░ ржЯрзЗржорзНржк ржлрж╛ржЗрж▓ ржбрж┐рж▓рж┐ржЯ
        } catch (e) {
          console.error("тЭМ ржнрж┐ржбрж┐ржУ ржкрж╛ржарж╛ржирзЛ ржпрж╛ржпрж╝ржирж┐:", e);
          api.sendMessage({ body: finalMsg }, event.threadID);
        }
      } else {
        api.sendMessage({ body: finalMsg }, event.threadID);
      }
    }
  }, 1000);
};
